<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Symptom Checker - VetTrack Ai</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-paw text-primary me-2"></i>
                <strong>VetTrack Ai</strong>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Header -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center">
                        <i class="fas fa-stethoscope text-primary display-4 mb-3"></i>
                        <h1 class="h2 fw-bold">AI Symptom Checker</h1>
                        <p class="text-muted">Get instant analysis of your pet's symptoms using advanced AI technology
                        </p>
                    </div>
                </div>

                <!-- Symptom Checker Form -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Describe Your Pet's Symptoms</h5>
                    </div>
                    <div class="card-body">
                        <form id="symptomForm">
                            <div class="mb-3">
                                <label for="petSelect" class="form-label">Select Pet</label>
                                <select class="form-select" id="petSelect" required>
                                    <option value="">Choose your pet...</option>
                                </select>
                                <div class="form-text">Don't see your pet? <a href="{{ url_for('dashboard') }}" target="_blank">Add a new pet</a>
                                    first.</div>
                            </div>

                            <div class="mb-3">
                                <label for="symptomsText" class="form-label">Symptoms Description</label>
                                <textarea class="form-control" id="symptomsText" rows="5"
                                    placeholder="Describe your pet's symptoms in detail. For example: 'My dog has been vomiting for 2 days, seems lethargic, and is not eating well. He's also drinking more water than usual.'"
                                    required></textarea>
                                <div class="form-text">
                                    <i class="fas fa-lightbulb text-warning me-1"></i>
                                    Be as specific as possible. Include duration, frequency, and any changes in
                                    behavior.
                                </div>
                            </div>

                            <!-- Common Symptoms Quick Select -->
                            <div class="mb-3">
                                <label class="form-label">Quick Select Common Symptoms (Optional)</label>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="vomiting"
                                                id="symptom1">
                                            <label class="form-check-label" for="symptom1">Vomiting</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="diarrhea"
                                                id="symptom2">
                                            <label class="form-check-label" for="symptom2">Diarrhea</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="lethargy"
                                                id="symptom3">
                                            <label class="form-check-label" for="symptom3">Lethargy</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="loss_of_appetite"
                                                id="symptom4">
                                            <label class="form-check-label" for="symptom4">Loss of Appetite</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="excessive_drinking"
                                                id="symptom5">
                                            <label class="form-check-label" for="symptom5">Excessive Drinking</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="coughing"
                                                id="symptom6">
                                            <label class="form-check-label" for="symptom6">Coughing</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="limping"
                                                id="symptom7">
                                            <label class="form-check-label" for="symptom7">Limping</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="scratching"
                                                id="symptom8">
                                            <label class="form-check-label" for="symptom8">Excessive Scratching</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="" id="symptomOther">
                                            <label class="form-check-label" for="symptomOther">Other:</label>
                                            <input type="text" class="form-control form-control-sm mt-1" id="otherSymptomText" placeholder="Describe other symptoms..." style="display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-robot me-2"></i>Analyze Symptoms
                                </button>
                            </div>
                        </form>

                        <!-- Loading State -->
                        <div id="loadingState" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Analyzing...</span>
                            </div>
                            <p class="mt-2 text-muted">AI is analyzing the symptoms...</p>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="card shadow-sm mt-4" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-diagnoses me-2"></i>AI Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultsContent">
                            <!-- Results will be populated here -->
                        </div>
                        <div id="ttsControlsSymptom" class="mt-2"></div>
                        <button id="listenBtnSymptom" type="button" class="btn btn-outline-secondary btn-sm mt-2" style="display:none">
                            <span style="font-size:14px">ðŸ”Š</span> Listen
                        </button>

                        <div class="mt-4 p-3 bg-light rounded">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Important
                                Disclaimer</h6>
                            <p class="small mb-0">This AI analysis is for informational purposes only and should not
                                replace professional veterinary care. Please consult with a qualified veterinarian for
                                accurate diagnosis and treatment.</p>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-success" onclick="startConsultation()">
                                <i class="fas fa-video me-1"></i>Schedule Consultation
                            </button>
                            <button class="btn btn-outline-primary" onclick="checkAnotherSymptom()">
                                <i class="fas fa-redo me-1"></i>Check Another Symptom
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Emergency Notice -->
                <div id="emergencyNotice" class="alert alert-danger mt-4" style="display: none;">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-circle me-2"></i>Emergency Alert</h5>
                    <p class="mb-0">Based on the symptoms described, this may require immediate veterinary attention.
                        Please contact your veterinarian or emergency pet clinic right away.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v=tts1"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        loadPetsForSelect();
    });

    function loadPetsForSelect() {
        fetch('/api/get_pets')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('petSelect');
                    select.innerHTML = '<option value="">Choose your pet...</option>';
                    data.pets.forEach(pet => {
                        select.innerHTML += `<option value="${pet.id}">${pet.name} (${pet.species})</option>`;
                    });
                }
            });
    }

    // Handle quick symptom selection
    document.querySelectorAll('input[type="checkbox"][id^="symptom"]').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            // Handle "Other" option
            if (this.id === 'symptomOther') {
                const otherInput = document.getElementById('otherSymptomText');
                if (this.checked) {
                    otherInput.style.display = 'block';
                    otherInput.required = true;
                } else {
                    otherInput.style.display = 'none';
                    otherInput.required = false;
                    otherInput.value = '';
                }
            }

            const textarea = document.getElementById('symptomsText');
            const symptoms = Array.from(document.querySelectorAll('input[type="checkbox"][id^="symptom"]:checked:not(#symptomOther)'))
                .map(cb => cb.value.replace('_', ' '))
                .filter(val => val); // Remove empty values

            // Add other symptom if specified
            const otherText = document.getElementById('otherSymptomText').value.trim();
            if (document.getElementById('symptomOther').checked && otherText) {
                symptoms.push(otherText);
            }

            if (symptoms.length > 0) {
                textarea.value = `Selected symptoms: ${symptoms.join(', ')}. ` + textarea.value.replace(/^Selected symptoms:.*?\. /, '');
            } else {
                textarea.value = textarea.value.replace(/^Selected symptoms:.*?\. /, '');
            }
        });
    });

    document.getElementById('symptomForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const petId = document.getElementById('petSelect').value;
        const symptoms = document.getElementById('symptomsText').value;
        const analyzeBtn = document.querySelector('#symptomForm button[type="submit"]');

        if (!petId || !symptoms.trim()) {
            showNotification('Please select a pet and describe symptoms', 'warning');
            return;
        }

        // Show loading state
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('emergencyNotice').style.display = 'none';

        // Update button state
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Loading...';

        // Submit to API
        fetch('/api/check_symptoms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pet_id: petId,
                symptoms: symptoms
            })
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingState').style.display = 'none';

                // Reset button
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-stethoscope me-2"></i> Analyze Symptoms';

                if (data.success) {
                    displayResults(data.analysis);
                } else {
                    showNotification('Error analyzing symptoms: ' + data.error, 'error');
                }
            })
            .catch(error => {
                document.getElementById('loadingState').style.display = 'none';

                // Reset button
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-stethoscope me-2"></i> Analyze Symptoms';

                showNotification('Error analyzing symptoms: ' + error.message, 'error');
            });
    });

    function displayResults(analysis) {
        document.getElementById('loadingState').style.display = 'none';
        const resultsContent = document.getElementById('resultsContent');

        const diagnosis = analysis.diagnosis || 'Not available';
        const recommendation = analysis.recommendation || 'Not available';
        const urgencyLevel = analysis.urgency_level || 'Unknown';

        const causes = Array.isArray(analysis.possible_causes)
            ? analysis.possible_causes
            : analysis.possible_causes
                ? [analysis.possible_causes]
                : ['Not available'];

        const urgencyColors = {
            'Low': 'success',
            'Medium': 'warning',
            'High': 'danger',
            'Emergency': 'danger'
        };
        const urgencyColor = urgencyColors[urgencyLevel] || 'secondary';

        resultsContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-diagnoses text-primary me-2"></i>Preliminary Diagnosis</h6>
                    <ul class="list-group list-group-flush">
                        ${Array.isArray(diagnosis)
                            ? diagnosis.map(d => `
                                <li class="list-group-item px-0">
                                    <a href="#" class="text-decoration-none" onclick="showDiagnosisExplanation('${d.replace(/'/g, "\\'")}')">
                                        ${d} <i class="fas fa-info-circle text-muted ms-1"></i>
                                    </a>
                                </li>
                            `).join('')
                            : `
                                <li class="list-group-item px-0">
                                    <a href="#" class="text-decoration-none" onclick="showDiagnosisExplanation('${diagnosis.replace(/'/g, "\\'")}')">
                                        ${diagnosis} <i class="fas fa-info-circle text-muted ms-1"></i>
                                    </a>
                                </li>
                            `
                        }
                    </ul>

                    <h6><i class="fas fa-exclamation-triangle text-warning me-2"></i>Urgency Level</h6>
                    <span class="badge bg-${urgencyColor} fs-6">${urgencyLevel}</span>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-lightbulb text-info me-2"></i>Possible Causes</h6>
                    <ul class="list-group list-group-flush">
                        ${causes.map(cause => `<li class="list-group-item px-0">${cause}</li>`).join('')}
                    </ul>
                </div>
            </div>

            <div class="mt-3">
                <h6><i class="fas fa-clipboard-list text-success me-2"></i>Recommendations</h6>
                <div class="bg-light p-3 rounded">
                    ${recommendation}
                </div>
            </div>
        `;

        document.getElementById('resultsSection').style.display = 'block';

        if (urgencyLevel === 'Emergency' || urgencyLevel === 'High') {
            document.getElementById('emergencyNotice').style.display = 'block';
        } else {
            document.getElementById('emergencyNotice').style.display = 'none';
        }

        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });

        // ---- TTS Integration ----
        const textForTts = (() => {
            const diag = Array.isArray(diagnosis) ? diagnosis.join(', ') : String(diagnosis);
            const causesText = (causes || []).join(', ');
            return `Here are your pet's symptom analysis results. The preliminary diagnosis suggests: ${diag}. The urgency level is ${urgencyLevel}. My recommendations are: ${recommendation}. Possible causes include: ${causesText}. Please consult with your veterinarian for professional medical advice.`;
        });
        
        // Show and wire the Listen button
        const listenBtn = document.getElementById('listenBtnSymptom');
        if (listenBtn) {
            listenBtn.style.display = 'inline-block';
            listenBtn.onclick = () => { speakText(textForTts()); };
        }
        
        // Attempt autoplay after content visible
        speakText(textForTts());
    }

    function startConsultation() {
        const petId = document.getElementById('petSelect').value;
        if (petId) {
            window.location.href = `/consultation/${petId}`;
        } else {
            showNotification('Please select a pet first', 'warning');
        }
    }

    function checkAnotherSymptom() {
        document.getElementById('symptomForm').reset();
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('emergencyNotice').style.display = 'none';
        document.querySelectorAll('input[type="checkbox"][id^="symptom"]').forEach(cb => cb.checked = false);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // showDiagnosisExplanation function is now available globally from app.js

    // Placeholder for showNotification function, assuming it exists in app.js or similar
    function showNotification(message, type) {
        console.log(`Notification (${type}): ${message}`);
        // In a real app, you'd use a toast or alert system
    }
</script>

</body>

</html>